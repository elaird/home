#!/usr/bin/env python

from string import ascii_lowercase
from datetime import datetime
from optparse import OptionParser
import os

def opts() :
    parser = OptionParser("usage: %prog [options]")
    parser.add_option("--test",     dest = "test",     default = False, action = "store_true",   help = "test this program")
    parser.add_option("--dir",      dest = "dir",      default = ".",   metavar = "d",           help = "specify directory (default is \".\")")
    parser.add_option("--rename",   dest = "rename",   default = False, action = "store_true",   help = "print file names to rename directory d")
    parser.add_option("--execute",  dest = "execute",  default = False, action = "store_true",   help = "execute the renaming shown by --rename")
    parser.add_option("--decode",   dest = "decode",   default = False, action = "store_true",   help = "decode file names in directory d")

    options,args = parser.parse_args()
    if options.execute and not options.rename :
        print "To execute the renaming, use both of --rename --execute"
        exit()
    return options

def key(dct = {}, value = None) :
    n = dct.values().count(value)
    assert n==1,"dictionary contains %d(!=1) keys with value %s"%(n, str(value))
    for k,v in dct.iteritems() :
        if v==value : return k

def years(yearZero = 2000) :
    out = {}
    for i,y in enumerate(range(10)+list(ascii_lowercase)) :
        out[yearZero + i] = str(y)
    return out

def months() :
    out = {}
    for i in range(1, 13) :
        out[i] = hex(i).replace("0x","")
    return out

#encodes a date into ym; year and month are each one character
def encoded(date = datetime.now()) :
    yearList = years().keys()
    assert date.year in years(),"Only the years [%d-%d] are supported (%d requested)."%(min(yearList), max(yearList), date.year)
    return years()[date.year]+months()[date.month]

#decodes the above format
def decoded(s = "", dummyDay = 1) :
    ys = years()
    ms = months()
    if len(s)!=2 or (s[0] not in ys.values()) or (s[1] not in ms.values()) : return None
    return datetime(year = key(ys, s[0]), month = key(ms, s[1]), day = dummyDay)

def test(day = 1) :
    for year in range(2000, 2036) :
        for month in range(1, 13) :
            date = datetime(year, month, day)
            enc = encoded(date)
            dec = decoded(enc, day)
            #print enc,dec
            assert dec==date,"%s decodes to %s rather than %s"%(enc, dec, date)

#decode file names within a directory
def decodeNames(directory = "") :
    l = []
    for item in os.listdir(directory) :
        d = decoded(item.split("_")[0])
        if d : l.append("(%4d-%02d) %s"%(d.year, d.month, item))

    for item in sorted(l) :
        print item

def rename(directory = "", descMap = lambda x:"_"+x, mv = "mv -i", execute = False) :
    for item in os.listdir(directory) :
        if decoded(item[:2]) and item[2]=="_" : continue #skip correctly formatted items
        if item[0]=="." : continue #skip dot files
        
        enc = encoded(date = datetime.fromtimestamp(os.path.getmtime(item)))
        cmd = " ".join([mv, item, enc+descMap(item)])
        print cmd
        if execute : os.system(cmd)

o = opts()

if o.test :
    test()

if o.decode :
    decodeNames(o.dir)

if o.rename :
    rename(directory = o.dir,
           #mv = "git mv",
           #descMap = lambda x:"_".join([""]+x.split("_")[1:]),
           execute = o.execute,
           )
